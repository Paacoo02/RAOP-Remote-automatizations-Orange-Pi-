<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>PymeEyes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #74ABE2, #5563DE);
    }
    .app-card {
      background: #fff;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,.2);
      width: 100%;
      max-width: 480px;
      animation: fadeIn .6s ease-out;
    }
    header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1.5rem;
    }
    header button {
      padding: .5rem .8rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: .95rem;
    }
    header button:first-child {
      background: #ddd;
    }
    header button:first-child:hover {
      background: #bbb;
    }
    header button#logout {
      background: #e74c3c;
      color: #fff;
    }
    header button#logout:hover {
      background: #c0392b;
    }
    h1 {
      margin-bottom: 1rem;
      text-align: center;
      color: #333;
    }
    .drop-zone {
      border: 2px dashed #888;
      border-radius: 10px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      margin-bottom: 1em;
      transition: background .2s, border-color .2s;
    }
    .drop-zone.dragover {
      background-color: #eef;
      border-color: #5563DE;
    }
    input[type=text] {
      width: 100%;
      padding: .7rem .9rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 1rem;
    }
    button.action {
      padding: .7rem 1rem;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      background: #5563DE;
      color: #fff;
      cursor: pointer;
      transition: background .2s;
      margin-right: .5rem;
    }
    button.action:hover {
      background: #3948b8;
    }
    #loading {
      display: none;
      margin: 1em 0;
      text-align: center;
    }
    .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      width: 40px; height: 40px;
      animation: spin 1s linear infinite;
      margin: auto;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    #popup {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }
    #popupContent {
      background: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      max-width: 420px;
      box-shadow: 0 8px 20px rgba(0,0,0,.3);
    }
    #popupContent a {
      display: block;
      margin: 1em 0;
      color: #5563DE;
      font-weight: 500;
    }
    #popupContent button {
      padding: .6rem 1rem;
      border: none;
      border-radius: 8px;
      background: #e74c3c;
      color: #fff;
      cursor: pointer;
    }
    #popupContent button:hover {
      background: #c0392b;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="app-card">
    <header>
      <button onclick="window.location.href='/dashboard.html'">‚Üê Volver al panel</button>
      <button id="logout">Cerrar sesi√≥n</button>
    </header>

    <h1>Aplicaci√≥n PymeEyes</h1>

    <div id="dropZone" class="drop-zone">
      Arrastra una imagen aqu√≠ o haz clic para seleccionarla
      <input type="file" id="fileInput" accept="image/*" style="display:none">
    </div>

    <input type="text" id="startUrl" placeholder="https://www.ejemplo.com">

    <div style="text-align:center;">
      <button id="sendBtn" class="action">Enviar</button>
      <button id="resetBtn" class="action" style="background:#888;">Resetear</button>
    </div>

    <div id="loading"><div class="spinner"></div></div>
  </div>

  <div id="popup">
    <div id="popupContent">
      <h2>Resultado</h2>
      <a id="resultLink" href="#" target="_blank">Ir al enlace</a>
      <button id="closePopup">Cerrar</button>
    </div>
  </div>

  <script>
    // Verificar sesi√≥n
    (async () => {
      const res = await fetch('/api/me');
      if (!res.ok) location.href = '/index.html';
    })();

    // Logout
    document.getElementById('logout').addEventListener('click', async () => {
      await fetch('/api/logout', { method: 'POST' });
      location.href = '/index.html';
    });

    const dropZone = document.getElementById("dropZone");
    const fileInput = document.getElementById("fileInput");
    let selectedFile = null;

    dropZone.addEventListener("click", () => fileInput.click());
    dropZone.addEventListener("dragover", e => { e.preventDefault(); dropZone.classList.add("dragover"); });
    dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
    dropZone.addEventListener("drop", e => {
      e.preventDefault(); dropZone.classList.remove("dragover");
      if (e.dataTransfer.files.length > 0) {
        selectedFile = e.dataTransfer.files[0];
        dropZone.textContent = "Imagen seleccionada: " + selectedFile.name;
      }
    });
    fileInput.addEventListener("change", e => {
      if (e.target.files.length > 0) {
        selectedFile = e.target.files[0];
        dropZone.textContent = "Imagen seleccionada: " + selectedFile.name;
      }
    });

    document.getElementById("sendBtn").addEventListener("click", async () => {
  const url = document.getElementById("startUrl").value;
  if (!selectedFile || !url) {
    alert("Debes seleccionar una imagen y una URL");
    return;
  }

  document.getElementById("loading").style.display = "block";
  const pngBlob = await toPNG(selectedFile);
  const formData = new FormData();
  formData.append("start_url", url);
  formData.append("file", pngBlob, "upload.png");

  // üîé DEBUG: mostrar lo que se env√≠a
  console.log("‚û°Ô∏è start_url:", url);
  console.log("‚û°Ô∏è File:", selectedFile);
  console.log("‚û°Ô∏è Blob convertido:", pngBlob);
  for (let [key, val] of formData.entries()) {
    console.log("‚û°Ô∏è FormData:", key, val);
  }

  try {
    const res = await fetch("http://localhost:8000/match", { 
      method: "POST", 
      body: formData 
    });
    const data = await res.json();
    console.log("‚úÖ Respuesta del servidor:", data);  // üëà DEBUG de respuesta

    const link = data.best_url || data.result || data.imageUrl;
    document.getElementById("resultLink").href = link;
    document.getElementById("resultLink").textContent = link;
    document.getElementById("popup").style.display = "flex";
  } catch (err) {
    console.error("‚ùå Error en fetch:", err);
    alert("Error: " + err.message);
  } finally {
    document.getElementById("loading").style.display = "none";
  }
});


    document.getElementById("resetBtn").addEventListener("click", resetForm);
    document.getElementById("closePopup").addEventListener("click", () => {
      document.getElementById("popup").style.display = "none";
      resetForm();
    });

    function resetForm() {
      selectedFile = null;
      dropZone.textContent = "Arrastra una imagen aqu√≠ o haz clic para seleccionarla";
      fileInput.value = "";
      document.getElementById("startUrl").value = "";
    }

    function toPNG(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const reader = new FileReader();
        reader.onload = e => {
          img.onload = () => {
            const canvas = document.createElement("canvas");
            canvas.width = img.width; canvas.height = img.height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0);
            canvas.toBlob(blob => resolve(blob), "image/png");
          };
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>
