<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LaTorre Auto</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
  <style>
    body { padding: 20px; }
    .class-card { margin-bottom: 15px; }
    .class-header { color: white; padding: 8px 16px; border-radius: 6px 6px 0 0; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-3">Clases</h2>
    <div id="status"></div>
    <div id="class-list"></div>
  </div>

  <script>
    const API_BASE = "https://la-torre-auto.vercel.app/api";
    let automation = JSON.parse(localStorage.getItem("automation") || "null");

    // Mostrar estado actual arriba
    function renderStatus() {
      const div = document.getElementById("status");
      if (!automation) {
        div.innerHTML = `<div class="alert alert-secondary">⚪ Sin automatización activa</div>`;
      } else if (automation.confirmed) {
        div.innerHTML = `
          <div class="alert alert-success">
            ✅ Clase confirmada: <b>${automation.className}</b> (${automation.classTime})
            <button class="btn btn-danger btn-sm float-end" onclick="cancelAutomation()">Cancelar</button>
          </div>`;
      } else {
        div.innerHTML = `
          <div class="alert alert-warning">
            ⏳ Automatización pendiente: <b>${automation.className}</b> (${automation.classTime})
            <button class="btn btn-danger btn-sm float-end" onclick="cancelAutomation()">Cancelar</button>
          </div>`;
      }
    }

    // Pintar lista de clases
    async function fetchClasses() {
      try {
        const res = await fetch(`${API_BASE}/list-tags`);
        if (!res.ok) throw new Error("Error " + res.status);
        const clases = await res.json();
        const list = document.getElementById("class-list");
        list.innerHTML = "";
        clases.forEach(c => {
          const card = document.createElement("div");
          card.className = "card class-card";
          card.innerHTML = `
            <div class="class-header" style="background-color:${c.color}">
              <div class="d-flex justify-content-between">
                <b>${c.title}</b>
                <span>${c.spots}/${c.total}</span>
              </div>
            </div>
            <div class="card-body">
              <p><b>Horario:</b> ${c.schedule}</p>
              <p><b>Monitor:</b> ${c.monitor}</p>
              <p><b>Descripción:</b> ${c.description}</p>
              <button class="btn btn-primary" onclick='automate(${JSON.stringify(c)})'>
                Automatizar
              </button>
            </div>`;
          list.appendChild(card);
        });
      } catch (err) {
        document.getElementById("class-list").innerHTML = `<div class="alert alert-danger">Error: ${err}</div>`;
      }
    }

    // Automatizar clase seleccionada
    async function automate(c) {
      try {
        const resp = await fetch(`${API_BASE}/class-settings`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ className: c.title, classTime: c.schedule })
        });
        if (!resp.ok) throw new Error("Falló class-settings");

        automation = {
          className: c.title,
          classTime: c.schedule,
          confirmed: false
        };
        localStorage.setItem("automation", JSON.stringify(automation));
        renderStatus();

        // Simular confirmación de reserva tras unos segundos
        setTimeout(() => {
          automation.confirmed = true;
          localStorage.setItem("automation", JSON.stringify(automation));
          renderStatus();
          alert(`✅ Reserva confirmada para ${c.title}`);
        }, 5000);

      } catch (e) {
        alert("❌ Error al automatizar: " + e.message);
      }
    }

    // Cancelar
    async function cancelAutomation() {
      if (!automation) return;
      try {
        const resp = await fetch(`${API_BASE}/cancel`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({
            className: automation.className,
            classTime: automation.classTime
          })
        });
        if (!resp.ok) throw new Error("Error cancelando");

        automation = null;
        localStorage.removeItem("automation");
        renderStatus();
        alert("✅ Reserva cancelada");
      } catch (e) {
        alert("❌ Error al cancelar: " + e.message);
      }
    }

    // inicial
    renderStatus();
    fetchClasses();
  </script>
</body>
</html>
