<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LaTorre Auto</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
  <style>
    body { padding: 20px; }
    .class-card { margin-bottom: 15px; }
    .class-header { color: white; padding: 8px 16px; border-radius: 6px 6px 0 0; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-3">Clases</h2>
    <div id="status"></div>
    <div id="class-list"></div>
  </div>

  <script>
    const API_BASE = "https://la-torre-auto.vercel.app/api";
    let automation = JSON.parse(localStorage.getItem("automation") || "null");
    let endTimer = null;

    // ========= Helpers =========
    function saveAutomation() {
      localStorage.setItem("automation", JSON.stringify(automation));
    }

    function clearAutomation(reason = "Clase finalizada, selecciona otra") {
      automation = null;
      localStorage.removeItem("automation");
      renderStatus();
      if (endTimer) clearTimeout(endTimer);
      alert(`üîÑ ${reason}`);
    }

    // ========= UI Rendering =========
    function renderStatus() {
      const div = document.getElementById("status");
      if (!automation) {
        div.innerHTML = `<div class="alert alert-secondary">‚ö™ Sin automatizaci√≥n activa</div>`;
      } else if (automation.confirmed) {
        div.innerHTML = `
          <div class="alert alert-success">
            ‚úÖ Clase confirmada: <b>${automation.className}</b> (${automation.classTime})
            <button class="btn btn-danger btn-sm float-end" onclick="cancelAutomation()">Cancelar</button>
          </div>`;
      } else {
        div.innerHTML = `
          <div class="alert alert-warning">
            ‚è≥ Automatizaci√≥n pendiente: <b>${automation.className}</b> (${automation.classTime})
            <button class="btn btn-danger btn-sm float-end" onclick="cancelAutomation()">Cancelar</button>
          </div>`;
      }
    }

    // ========= Clase termina autom√°ticamente =========
    function scheduleEndOfClass(classTime) {
      const parts = classTime.split(/[-‚Äì]/).map(p => p.trim());
      if (parts.length < 2) return console.warn("[END] Formato inv√°lido:", classTime);

      const [_, endPart] = parts;
      const [h, m] = endPart.split(":").map(Number);
      const now = new Date();
      const end = new Date();
      end.setHours(h, m, 0, 0);
      if (end < now) end.setDate(end.getDate() + 1);

      const ms = end - now;
      console.log(`[END] Programado fin en ${(ms / 60000).toFixed(1)} minutos`);

      if (endTimer) clearTimeout(endTimer);
      endTimer = setTimeout(() => clearAutomation("Clase finalizada autom√°ticamente"), ms);
    }

    // ========= Recuperar estado (como _loadInitialPrefs en Flutter) =========
    function restoreState() {
      if (!automation) return;

      const parts = automation.classTime.split(/[-‚Äì]/).map(p => p.trim());
      if (parts.length < 2) return;
      const [_, endPart] = parts;
      const [h, m] = endPart.split(":").map(Number);

      const now = new Date();
      const endToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m);

      if (now > endToday) {
        clearAutomation("La clase anterior ya finaliz√≥");
      } else {
        const ms = endToday - now;
        console.log(`[RESTORE] Clase a√∫n activa, restableciendo temporizador (${(ms / 60000).toFixed(1)} min)`);
        if (endTimer) clearTimeout(endTimer);
        endTimer = setTimeout(() => clearAutomation("Clase finalizada autom√°ticamente"), ms);
      }
    }

    // ========= API: Listar clases =========
    async function fetchClasses() {
      try {
        const res = await fetch(`${API_BASE}/list-tags`);
        if (!res.ok) throw new Error("Error " + res.status);
        const clases = await res.json();
        const list = document.getElementById("class-list");
        list.innerHTML = "";
        clases.forEach(c => {
          const card = document.createElement("div");
          card.className = "card class-card";
          card.innerHTML = `
            <div class="class-header" style="background-color:${c.color}">
              <div class="d-flex justify-content-between">
                <b>${c.title}</b>
                <span>${c.spots}/${c.total}</span>
              </div>
            </div>
            <div class="card-body">
              <p><b>Horario:</b> ${c.schedule}</p>
              <p><b>Monitor:</b> ${c.monitor}</p>
              <p><b>Descripci√≥n:</b> ${c.description}</p>
              <button class="btn btn-primary" onclick='automate(${JSON.stringify(c)})'>
                Automatizar
              </button>
            </div>`;
          list.appendChild(card);
        });
      } catch (err) {
        document.getElementById("class-list").innerHTML =
          `<div class="alert alert-danger">Error: ${err.message}</div>`;
      }
    }

    // ========= Automatizar clase =========
    async function automate(c) {
      try {
        const resp = await fetch(`${API_BASE}/class-settings`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ className: c.title, classTime: c.schedule })
        });
        if (!resp.ok) throw new Error("Fall√≥ class-settings");

        automation = {
          className: c.title,
          classTime: c.schedule,
          confirmed: false
        };
        saveAutomation();
        renderStatus();
        scheduleEndOfClass(c.schedule);

        // Simular confirmaci√≥n de reserva (como el callback nativo)
        setTimeout(() => {
          if (!automation) return;
          automation.confirmed = true;
          saveAutomation();
          renderStatus();
          alert(`‚úÖ Reserva confirmada para ${c.title}`);
        }, 5000);

      } catch (e) {
        alert("‚ùå Error al automatizar: " + e.message);
      }
    }

    // ========= Cancelar automatizaci√≥n =========
    async function cancelAutomation() {
      if (!automation) return;
      try {
        const resp = await fetch(`${API_BASE}/cancel`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({
            className: automation.className,
            classTime: automation.classTime
          })
        });
        if (!resp.ok) throw new Error("Error cancelando");

        clearAutomation("Reserva cancelada manualmente");
      } catch (e) {
        alert("‚ùå Error al cancelar: " + e.message);
      }
    }

    // ========= Inicializaci√≥n =========
    renderStatus();
    fetchClasses();
    restoreState();
  </script>
</body>
</html>
